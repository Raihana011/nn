<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<meta name="theme-color" content="#06090f">
<title>The Neural Night</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=IM+Fell+English:ital@0;1&family=JetBrains+Mono:wght@400;700&display=swap');

* { margin:0; padding:0; box-sizing:border-box; }

:root {
  --ink: #06090f;
  --gold: #ffd966;
  --cream: #f5e6c8;
  --blue: #1e4fa0;
  --ember: #e87020;
}

body {
  background: var(--ink);
  color: var(--cream);
  font-family: 'IM Fell English', serif;
  overflow: hidden;
  width: 100vw; height: 100vh;
  touch-action: none;
}

/* INTRO SCREEN */
#intro {
  position: fixed; inset: 0; z-index: 100;
  background: radial-gradient(ellipse at center, #0d1520, #040608);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 2.5rem;
  transition: opacity 0.9s ease, visibility 0.9s;
}
#intro.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

.intro-title {
  font-family: 'Cinzel', serif;
  font-weight: 900;
  font-size: clamp(2.8rem, 10vw, 5rem);
  text-align: center;
  color: var(--cream);
  text-shadow: 0 0 80px rgba(255,217,102,0.6), 0 0 40px rgba(255,235,153,0.8);
  line-height: 0.95;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}
.intro-title span { 
  color: var(--gold);
  text-shadow: 0 0 100px rgba(255,235,153,1), 0 0 50px #fff;
}

.intro-sub {
  font-style: italic;
  font-size: clamp(0.9rem, 2.8vw, 1.2rem);
  color: rgba(245,230,200,0.6);
  text-align: center;
  max-width: 380px;
  line-height: 1.85;
}

.mode-buttons {
  display: flex; flex-direction: column;
  gap: 1rem;
  width: min(340px, 88vw);
  margin-top: 1rem;
}

.mode-btn {
  padding: 1.2rem 1.8rem;
  border: 2px solid rgba(255,217,102,0.4);
  background: rgba(255,217,102,0.08);
  color: var(--cream);
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: 1.05rem;
  cursor: pointer;
  border-radius: 6px;
  display: flex; align-items: center; gap: 1rem;
  transition: all 0.3s;
  box-shadow: 0 0 20px rgba(255,217,102,0.15);
}
.mode-btn:hover, .mode-btn:active {
  background: rgba(255,217,102,0.18);
  border-color: rgba(255,217,102,0.7);
  color: var(--gold);
  box-shadow: 0 0 35px rgba(255,217,102,0.35);
  transform: translateY(-3px);
}
.mode-btn .icon { font-size: 1.6rem; }
.mode-btn .btn-text { display: flex; flex-direction: column; gap: 0.2rem; flex: 1; }
.mode-btn .btn-label { font-size: 1.05rem; font-weight: bold; }
.mode-btn .btn-desc { font-size: 0.75rem; color: rgba(245,230,200,0.5); }

/* AR VIEW */
#ar-view {
  position: fixed; inset: 0; z-index: 50;
  display: none;
}
#ar-view.active { display: block; }

#camera-feed {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
}

#ar-canvas {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
}

.ar-ui {
  position: absolute; inset: 0;
  pointer-events: none;
  display: flex; flex-direction: column;
  justify-content: space-between;
  padding: 1.8rem 1.5rem;
}

.ar-top {
  display: flex; justify-content: space-between; align-items: flex-start;
  pointer-events: auto;
}

.ar-badge {
  background: rgba(6,9,15,0.85);
  border: 2px solid rgba(255,217,102,0.5);
  padding: 0.5rem 1.1rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: bold;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--gold);
  backdrop-filter: blur(12px);
  box-shadow: 0 0 25px rgba(255,217,102,0.35);
}

.ar-back-btn {
  background: rgba(6,9,15,0.85);
  border: 2px solid rgba(245,230,200,0.3);
  color: var(--cream);
  padding: 0.5rem 1.1rem;
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: 0.9rem;
  cursor: pointer;
  border-radius: 4px;
  backdrop-filter: blur(12px);
  transition: all 0.25s;
  box-shadow: 0 0 15px rgba(0,0,0,0.5);
}
.ar-back-btn:active {
  background: rgba(6,9,15,0.95);
  border-color: rgba(255,217,102,0.6);
  color: var(--gold);
  transform: scale(0.96);
}

.ar-hint {
  position: absolute;
  bottom: 2rem; left: 50%;
  transform: translateX(-50%);
  font-style: italic;
  font-size: 0.85rem;
  color: rgba(245,230,200,0.7);
  text-align: center;
  background: rgba(6,9,15,0.75);
  padding: 0.6rem 1.2rem;
  border-radius: 4px;
  border: 1px solid rgba(255,217,102,0.3);
  backdrop-filter: blur(12px);
  pointer-events: none;
}

.ar-no-camera {
  display: none;
  position: absolute; inset: 0;
  background: radial-gradient(ellipse, #0d1520, #040608);
  flex-direction: column; align-items: center; justify-content: center;
  gap: 1.5rem; text-align: center; padding: 2rem;
  z-index: 10;
}
.ar-no-camera.visible { display: flex; }
.ar-no-camera p { font-style: italic; color: rgba(245,230,200,0.7); line-height: 1.9; font-size: 1.05rem; }

/* PAINT VIEW */
#paint-view {
  position: fixed; inset: 0; z-index: 50;
  display: none;
}
#paint-view.active { display: block; }

#paint-canvas {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
}

.paint-ui {
  position: absolute; inset: 0;
  pointer-events: none;
}

.paint-title {
  position: absolute;
  top: clamp(1.2rem, 4.5vw, 2rem);
  left: clamp(1.2rem, 4.5vw, 2rem);
  font-family: 'Cinzel', serif;
  font-weight: 900;
  font-size: clamp(1.3rem, 4vw, 2.2rem);
  color: var(--cream);
  text-shadow: 0 3px 25px rgba(0,0,0,1), 0 0 60px rgba(255,217,102,0.5);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.paint-back-btn {
  position: absolute;
  top: clamp(1.2rem, 4.5vw, 2rem);
  right: clamp(1.2rem, 4.5vw, 2rem);
  background: rgba(6,9,15,0.88);
  border: 2px solid rgba(245,230,200,0.3);
  color: var(--cream);
  padding: 0.5rem 1rem;
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: 0.85rem;
  cursor: pointer;
  border-radius: 4px;
  pointer-events: auto;
  backdrop-filter: blur(12px);
  transition: all 0.25s;
}
.paint-back-btn:active {
  border-color: rgba(255,217,102,0.6);
  color: var(--gold);
  transform: scale(0.95);
}

.bottom-panel {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  background: linear-gradient(to top, rgba(6,9,15,0.96) 70%, transparent);
  padding: clamp(1.2rem, 3.5vw, 2rem);
  padding-top: 4rem;
  backdrop-filter: blur(15px);
  pointer-events: auto;
  max-height: 55vh;
  overflow-y: auto;
}

.control-row {
  display: flex;
  gap: clamp(0.6rem, 2.2vw, 1.2rem);
  align-items: flex-start;
  margin-bottom: clamp(1rem, 2.5vw, 1.5rem);
  flex-wrap: wrap;
}

.prompt-input-box {
  flex: 1;
  min-width: 220px;
  background: rgba(245,230,200,0.1);
  border: 1.5px solid rgba(245,230,200,0.25);
  border-radius: 4px;
  padding: 0.7rem 1rem;
  font-family: 'IM Fell English', serif;
  font-style: italic;
  font-size: clamp(0.85rem, 2.2vw, 1rem);
  color: var(--cream);
  resize: none;
  outline: none;
  transition: all 0.3s;
}
.prompt-input-box:focus {
  border-color: rgba(255,217,102,0.6);
  box-shadow: 0 0 20px rgba(255,217,102,0.2);
}
.prompt-input-box::placeholder { color: rgba(245,230,200,0.4); }

.generate-btn {
  background: rgba(255,217,102,0.25);
  border: 2px solid rgba(255,217,102,0.6);
  color: var(--gold);
  padding: 0.7rem 1.4rem;
  font-family: 'Cinzel', serif;
  font-weight: 700;
  font-size: clamp(0.8rem, 2.2vw, 0.95rem);
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.25s;
  letter-spacing: 0.12em;
  white-space: nowrap;
  text-transform: uppercase;
  box-shadow: 0 0 20px rgba(255,217,102,0.3);
}
.generate-btn:hover {
  background: rgba(255,217,102,0.35);
  box-shadow: 0 0 30px rgba(255,217,102,0.5);
}
.generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.word-journey {
  margin-bottom: 1.2rem;
  min-height: 3rem;
}

.journey-label {
  font-size: 0.65rem;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: rgba(255,217,102,0.6);
  margin-bottom: 0.6rem;
  font-weight: bold;
}

.word-tokens {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.word-token {
  padding: 0.4rem 0.8rem;
  background: rgba(245,230,200,0.1);
  border: 1.5px solid rgba(245,230,200,0.2);
  border-radius: 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  color: rgba(245,230,200,0.6);
  transition: all 0.35s;
}

.word-token.active {
  background: rgba(255,217,102,0.3);
  border-color: rgba(255,217,102,0.8);
  color: var(--gold);
  box-shadow: 0 0 20px rgba(255,217,102,0.5);
  transform: scale(1.05);
}

.prediction-panel {
  background: rgba(6,9,15,0.7);
  border: 1.5px solid rgba(255,217,102,0.4);
  border-radius: 4px;
  padding: 1rem;
  backdrop-filter: blur(10px);
}

.prediction-label {
  font-size: 0.7rem;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: rgba(255,217,102,0.7);
  margin-bottom: 0.8rem;
  font-weight: bold;
}

.prediction-bars {
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
}

.pred-row {
  display: flex;
  align-items: center;
  gap: 0.7rem;
  opacity: 0;
  transform: translateX(-15px);
  transition: all 0.5s;
}

.pred-row.visible {
  opacity: 1;
  transform: translateX(0);
}

.pred-word {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  color: var(--cream);
  width: clamp(55px, 17vw, 90px);
  flex-shrink: 0;
}

.pred-bar-wrap {
  flex: 1;
  height: 22px;
  background: rgba(255,255,255,0.06);
  border-radius: 3px;
  overflow: hidden;
}

.pred-bar {
  height: 100%;
  border-radius: 3px;
  transform: scaleX(0);
  transform-origin: left;
  transition: transform 1s ease;
}

.pred-row.visible .pred-bar { transform: scaleX(1); }

.pred-bar.top {
  background: linear-gradient(90deg, var(--ember), var(--gold));
  box-shadow: 0 0 15px rgba(255,217,102,0.5);
}

.pred-bar.other {
  background: linear-gradient(90deg, rgba(30,79,160,0.7), rgba(90,143,212,0.5));
}

.pred-pct {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: rgba(245,230,200,0.5);
  width: 45px;
  text-align: right;
  flex-shrink: 0;
}

.vignette {
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at center,
    transparent 30%, rgba(3,5,10,0.45) 65%, rgba(2,3,8,0.8) 100%);
  pointer-events: none;
}

.paint-legend {
  position: absolute;
  top: clamp(1.2rem,3.5vw,2rem);
  right: clamp(1.2rem,3.5vw,2rem);
  display: flex; flex-direction: column; gap: 0.4rem;
  margin-top: 3.5rem;
}
.legend-item {
  display: flex; align-items: center; gap: 0.5rem;
  font-size: 0.6rem; color: rgba(245,230,200,0.5); font-style: italic;
}
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

</style>
</head>
<body>

<!-- INTRO -->
<div id="intro">
  <div class="intro-title">The Neural<br><span>Night</span></div>
  <p class="intro-sub">Experience language model neurons painted in Van Gogh's style ‚Äî watch words transform into meaning through swirling starlight</p>
  <div class="mode-buttons">
    <button class="mode-btn" onclick="startAR()">
      <span class="icon">üì∑</span>
      <span class="btn-text">
        <span class="btn-label">AR Mode</span>
        <span class="btn-desc">Interactive neurons over your print ‚Äî tap, swipe, double-tap</span>
      </span>
    </button>
    <button class="mode-btn" onclick="startPainting()">
      <span class="icon">üé®</span>
      <span class="btn-text">
        <span class="btn-label">Neural Journey</span>
        <span class="btn-desc">Watch words flow through 6 layers with next-word predictions</span>
      </span>
    </button>
  </div>
</div>

<!-- AR VIEW -->
<div id="ar-view">
  <video id="camera-feed" autoplay playsinline muted></video>
  <canvas id="ar-canvas"></canvas>

  <div class="ar-no-camera" id="ar-no-camera">
    <div style="font-size:3rem">üì∑</div>
    <p>Camera access needed for AR.<br>Please allow permission and reload.</p>
    <button class="mode-btn" onclick="backToIntro()" style="pointer-events:auto; margin-top:1rem">
      <span class="icon">‚Üê</span>
      <span class="btn-text"><span class="btn-label">Go back</span></span>
    </button>
  </div>

  <div class="ar-ui">
    <div class="ar-top">
      <div class="ar-badge" id="arStatus">READY</div>
      <button class="ar-back-btn" onclick="backToIntro()">‚úï Exit AR</button>
    </div>
  </div>

  <div class="ar-hint">
    Tap neurons ‚Ä¢ Swipe for cascade ‚Ä¢ Double-tap for explosion
  </div>
</div>

<!-- PAINT VIEW -->
<div id="paint-view">
  <canvas id="paint-canvas"></canvas>
  <div class="vignette"></div>
  <div class="paint-ui">
    <div class="paint-title">Neural Night</div>
    <button class="paint-back-btn" onclick="backToIntro()">‚úï Exit</button>
    
    <div class="paint-legend">
      <div class="legend-item"><div class="legend-dot" style="background:#5a8fd4"></div>Dormant</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ffd966"></div>Firing</div>
      <div class="legend-item"><div class="legend-dot" style="background:#7dcf7d"></div>Inhibitory</div>
      <div class="legend-item"><div class="legend-dot" style="background:#c870e8"></div>Attention</div>
    </div>
    
    <div class="bottom-panel">
      <div class="control-row">
        <textarea class="prompt-input-box" id="promptInput" rows="1" placeholder="Type your sentence here... (e.g., 'The stars whisper secrets')"></textarea>
        <button class="generate-btn" id="generateBtn" onclick="processPrompt()">Process</button>
      </div>
      
      <div class="word-journey">
        <div class="journey-label">‚¨¢ Word Journey Through Layers</div>
        <div class="word-tokens" id="wordTokens"></div>
      </div>
      
      <div class="prediction-panel" id="predictionPanel" style="display:none">
        <div class="prediction-label">‚¨¢ Next Word Predictions</div>
        <div class="prediction-bars" id="predictionBars"></div>
      </div>
    </div>
  </div>
</div>

<script>
let currentMode = 'intro';
let arStream = null;
let paintAnim = null;

function backToIntro() {
  if (arStream) { 
    arStream.getTracks().forEach(t => t.stop()); 
    arStream = null; 
  }
  if (paintAnim) { 
    cancelAnimationFrame(paintAnim); 
    paintAnim = null; 
  }
  document.getElementById('ar-view').classList.remove('active');
  document.getElementById('paint-view').classList.remove('active');
  document.getElementById('intro').classList.remove('hidden');
  currentMode = 'intro';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENHANCED INTERACTIVE AR MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startAR() {
  document.getElementById('intro').classList.add('hidden');
  document.getElementById('ar-view').classList.add('active');
  currentMode = 'ar';

  const video = document.getElementById('camera-feed');
  const canvas = document.getElementById('ar-canvas');
  const noCam = document.getElementById('ar-no-camera');

  try {
    arStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    video.srcObject = arStream;
    await video.play();
    noCam.classList.remove('visible');
    runInteractiveAR(canvas, video);
  } catch(e) {
    noCam.classList.add('visible');
    video.style.display = 'none';
    runInteractiveAR(canvas, null);
  }
}

function runInteractiveAR(canvas, video) {
  const ctx = canvas.getContext('2d');
  let W, H;
  function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
  resize();
  window.addEventListener('resize', resize);

  const AR_NEURONS = [];
  for (let i = 0; i < 80; i++) { // MORE neurons
    AR_NEURONS.push({
      x: Math.random(), y: Math.random(),
      vx: (Math.random()-0.5)*0.0004, vy: (Math.random()-0.5)*0.0004,
      r: 3 + Math.random()*11, // Bigger
      fireTimer: 0,
      type: Math.random()<0.13 ? 'attn' : (Math.random()<0.16 ? 'inhib' : 'excit'),
      connections: [],
      pulsePhase: Math.random()*Math.PI*2,
    });
  }

  AR_NEURONS.forEach(n => {
    AR_NEURONS.forEach(m => {
      if (n === m) return;
      const dx = n.x-m.x, dy = n.y-m.y;
      if (Math.sqrt(dx*dx+dy*dy) < 0.18 && Math.random()<0.35) n.connections.push(m);
    });
  });

  let arSignals = [];
  let arStars = []; // Particle effects
  let t = 0;
  let touchStart = null;
  let lastTap = 0;

  // INTERACTIVE TOUCH EVENTS
  canvas.addEventListener('pointerdown', e => {
    touchStart = {x: e.clientX, y: e.clientY, time: Date.now()};
    const tx = e.clientX/W, ty = e.clientY/H;
    
    // Find nearest neuron
    let best = null, bd = 9999;
    AR_NEURONS.forEach(n => {
      const d = Math.sqrt((n.x-tx)**2+(n.y-ty)**2);
      if(d<bd){bd=d;best=n;}
    });
    
    if(best && bd < 0.15) {
      // TAP NEURON - fire it!
      best.fireTimer = 90;
      best.connections.forEach(c => {
        setTimeout(() => {
          c.fireTimer = 60;
          arSignals.push({from:best, to:c, p:0, speed:0.03});
        }, 120);
      });
      
      // Create star burst
      for(let i=0;i<12;i++) {
        const angle = Math.random()*Math.PI*2;
        arStars.push({
          x: best.x, y: best.y,
          vx: Math.cos(angle)*0.003,
          vy: Math.sin(angle)*0.003,
          life: 1, decay: 0.015,
        });
      }
      
      document.getElementById('arStatus').textContent = 'NEURON FIRED';
      setTimeout(() => document.getElementById('arStatus').textContent = 'READY', 800);
    }
  });

  canvas.addEventListener('pointerup', e => {
    if(!touchStart) return;
    const dx = e.clientX - touchStart.x;
    const dy = e.clientY - touchStart.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const duration = Date.now() - touchStart.time;
    
    // SWIPE DETECTION
    if(dist > 80 && duration < 500) {
      // CASCADE across layers!
      const dir = Math.atan2(dy, dx);
      const starters = AR_NEURONS.filter(n => 
        Math.abs(Math.atan2(n.y-touchStart.y/H, n.x-touchStart.x/W) - dir) < 0.8
      ).slice(0, 5);
      
      starters.forEach((n, idx) => {
        setTimeout(() => {
          n.fireTimer = 70;
          n.connections.forEach(c => {
            setTimeout(() => {
              c.fireTimer = 50;
              arSignals.push({from:n, to:c, p:0, speed:0.025});
            }, 100);
          });
        }, idx * 150);
      });
      
      document.getElementById('arStatus').textContent = 'CASCADE!';
      setTimeout(() => document.getElementById('arStatus').textContent = 'READY', 1200);
    }
    
    // DOUBLE TAP DETECTION
    const now = Date.now();
    if(now - lastTap < 300 && dist < 30) {
      // EXPLOSION - fire ALL neurons!
      AR_NEURONS.forEach((n, i) => {
        setTimeout(() => {
          n.fireTimer = 80;
          // Radial star burst
          for(let j=0;j<8;j++) {
            const angle = (j/8)*Math.PI*2;
            arStars.push({
              x: n.x, y: n.y,
              vx: Math.cos(angle)*0.004,
              vy: Math.sin(angle)*0.004,
              life: 1, decay: 0.012,
            });
          }
        }, i * 20);
      });
      
      document.getElementById('arStatus').textContent = 'EXPLOSION!';
      setTimeout(() => document.getElementById('arStatus').textContent = 'READY', 1500);
    }
    lastTap = now;
    touchStart = null;
  });

  function drawARNeuron(n) {
    const x = n.x*W, y = n.y*H;
    const firing = n.fireTimer > 0;
    const pulse = firing ? Math.sin(n.fireTimer*0.35)*0.6+0.4 : 0;
    const r = n.r * (1 + pulse*2.5);
    let color = firing ? '#ffd966' : (n.type==='attn' ? '#c870e8' : n.type==='inhib' ? '#7dcf7d' : '#3a70d0');
    let glowCol = firing ? '#fffacc' : color;

    // STARRY glow rings - MORE prominent
    for(let ring=5;ring>=1;ring--){
      const rr = r*(1+ring*0.9+pulse*ring*0.6);
      const grd = ctx.createRadialGradient(x,y,0,x,y,rr);
      grd.addColorStop(0, glowCol+(firing?'80':'60'));
      grd.addColorStop(1,'transparent');
      ctx.beginPath(); ctx.arc(x,y,rr,0,Math.PI*2);
      ctx.fillStyle = grd; ctx.globalAlpha=0.7; ctx.fill();
    }
    ctx.globalAlpha=1;

    // Body
    for(let d=0;d<6;d++){
      const dx=x+(Math.random()-0.5)*r*0.8, dy2=y+(Math.random()-0.5)*r*0.8;
      ctx.beginPath(); ctx.arc(dx,dy2,r*(0.45+Math.random()*0.55),0,Math.PI*2);
      ctx.fillStyle=color; ctx.globalAlpha=0.7+Math.random()*0.3; ctx.fill();
    }
    ctx.globalAlpha=1;

    // Sparkles around firing neurons
    if(firing) {
      for(let i=0;i<8;i++){
        const a=Math.random()*Math.PI*2, d2=r*2.5+Math.random()*12;
        ctx.beginPath();
        ctx.arc(x+Math.cos(a)*d2, y+Math.sin(a)*d2, 1+Math.random()*2, 0, Math.PI*2);
        ctx.fillStyle='#fffacc';
        ctx.shadowColor='#fffacc';
        ctx.shadowBlur=6;
        ctx.globalAlpha=0.5+Math.random()*0.5;
        ctx.fill();
        ctx.shadowBlur=0;
      }
      ctx.globalAlpha=1;
    }

    if(n.fireTimer>0) n.fireTimer--;
  }

  function loop() {
    if(currentMode !== 'ar') return;
    t += 0.018;
    ctx.clearRect(0,0,W,H);

    // Draw connections
    AR_NEURONS.forEach(n=>{
      n.connections.forEach(m=>{
        ctx.save();
        ctx.globalAlpha=0.15;
        ctx.beginPath();
        ctx.moveTo(n.x*W,n.y*H); 
        
        const dx=(m.x-n.x)*W, dy=(m.y-n.y)*H;
        const cpx1=n.x*W+dx*0.4+(Math.random()-0.5)*20;
        const cpy1=n.y*H+dy*0.4+(Math.random()-0.5)*20;
        const cpx2=n.x*W+dx*0.6+(Math.random()-0.5)*20;
        const cpy2=n.y*H+dy*0.6+(Math.random()-0.5)*20;
        ctx.bezierCurveTo(cpx1,cpy1,cpx2,cpy2,m.x*W,m.y*H);
        
        ctx.strokeStyle='#5a90e0'; 
        ctx.lineWidth=1.5; 
        ctx.stroke();
        ctx.restore();
      });
    });

    // Draw neurons
    AR_NEURONS.forEach(n=>{
      n.x+=n.vx; n.y+=n.vy;
      if(n.x<0.02)n.x=0.02; if(n.x>0.98)n.x=0.98;
      if(n.y<0.02)n.y=0.02; if(n.y>0.98)n.y=0.98;
      drawARNeuron(n);
    });

    // Draw signals
    arSignals = arSignals.filter(s=>{
      s.p += s.speed;
      const x = (s.from.x+(s.to.x-s.from.x)*s.p)*W;
      const y = (s.from.y+(s.to.y-s.from.y)*s.p)*H;
      const grd2 = ctx.createRadialGradient(x,y,0,x,y,10);
      grd2.addColorStop(0,'#ffffff');
      grd2.addColorStop(0.4,'#ffd966');
      grd2.addColorStop(1,'transparent');
      ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2);
      ctx.fillStyle=grd2; ctx.globalAlpha=0.95; ctx.fill(); ctx.globalAlpha=1;
      return s.p < 1;
    });

    // Draw particle stars
    arStars = arStars.filter(s => {
      s.x += s.vx; s.y += s.vy;
      s.life -= s.decay;
      if(s.life <= 0) return false;
      
      ctx.fillStyle = '#fffacc';
      ctx.shadowColor = '#fffacc';
      ctx.shadowBlur = 8;
      ctx.globalAlpha = s.life;
      ctx.beginPath();
      ctx.arc(s.x*W, s.y*H, 2+s.life*3, 0, Math.PI*2);
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.globalAlpha = 1;
      return true;
    });

    requestAnimationFrame(loop);
  }
  loop();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAINTING MODE (same as before with enhancements)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let neurons = [];
let signals = [];
let wordTokens = [];

function startPainting() {
  document.getElementById('intro').classList.add('hidden');
  document.getElementById('paint-view').classList.add('active');
  currentMode = 'paint';
  runPainting();
}

async function processPrompt() {
  const prompt = document.getElementById('promptInput').value.trim();
  if(!prompt) return;
  
  document.getElementById('generateBtn').disabled = true;
  document.getElementById('predictionPanel').style.display = 'none';
  document.getElementById('wordTokens').innerHTML = '';
  
  const words = prompt.split(/\s+/);
  wordTokens = words.map((w, i) => ({text: w, id: i, el: null}));
  
  wordTokens.forEach(tok => {
    const el = document.createElement('div');
    el.className = 'word-token';
    el.textContent = tok.text;
    tok.el = el;
    document.getElementById('wordTokens').appendChild(el);
  });
  
  for(let i = 0; i < wordTokens.length; i++) {
    await processWord(wordTokens[i]);
    await delay(800);
  }
  
  await delay(400);
  showPredictions(words[words.length - 1]);
  document.getElementById('generateBtn').disabled = false;
}

async function processWord(token) {
  token.el.classList.add('active');
  
  for(let layer = 0; layer < 6; layer++) {
    const layerNeurons = neurons.filter(n => n.layer === layer);
    const toFire = layerNeurons.slice(0, 2 + Math.floor(Math.random()*2));
    toFire.forEach(n => {
      n.fireTimer = 50;
      n.activation = 1;
      n.connections.forEach(conn => {
        signals.push({
          x: n.x, y: n.y,
          tx: conn.to.x, ty: conn.to.y,
          p: 0, speed: 0.025,
          color: '#ffd966', trail: []
        });
      });
    });
    await delay(200);
  }
  
  await delay(200);
  token.el.classList.remove('active');
}

function showPredictions(lastWord) {
  document.getElementById('predictionPanel').style.display = 'block';
  
  const predictionSets = {
    'the': [{word: 'universe', prob: 0.34},{word: 'stars', prob: 0.22},{word: 'night', prob: 0.15},{word: 'cosmos', prob: 0.12},{word: 'void', prob: 0.08}],
    'universe': [{word: 'whispers', prob: 0.38},{word: 'expands', prob: 0.24},{word: 'contains', prob: 0.16},{word: 'speaks', prob: 0.11},{word: 'dreams', prob: 0.06}],
    'whispers': [{word: 'secrets', prob: 0.41},{word: 'softly', prob: 0.25},{word: 'in', prob: 0.15},{word: 'through', prob: 0.10},{word: 'ancient', prob: 0.05}],
    'stars': [{word: 'shine', prob: 0.36},{word: 'whisper', prob: 0.28},{word: 'dance', prob: 0.17},{word: 'glow', prob: 0.10},{word: 'fade', prob: 0.05}],
    'default': [{word: 'and', prob: 0.32},{word: 'the', prob: 0.26},{word: 'in', prob: 0.18},{word: 'of', prob: 0.12},{word: 'to', prob: 0.08}]
  };
  
  const preds = predictionSets[lastWord.toLowerCase()] || predictionSets['default'];
  
  const barsHTML = preds.map((p, i) => `
    <div class="pred-row" style="transition-delay:${i*0.12}s">
      <div class="pred-word">${p.word}</div>
      <div class="pred-bar-wrap">
        <div class="pred-bar ${i===0?'top':'other'}" style="width:${p.prob*100}%"></div>
      </div>
      <div class="pred-pct">${(p.prob*100).toFixed(0)}%</div>
    </div>
  `).join('');
  
  document.getElementById('predictionBars').innerHTML = barsHTML;
  setTimeout(() => {
    document.querySelectorAll('.pred-row').forEach(el => el.classList.add('visible'));
  }, 50);
}

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function runPainting() {
  const canvas = document.getElementById('paint-canvas');
  const ctx = canvas.getContext('2d');
  let W, H;

  function resize(){ W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight; }
  resize(); window.addEventListener('resize',()=>{resize(); buildNeurons();});

  const PAL={
    sky:['#0d1b3e','#112244','#0a1530','#162855','#0e1f40','#081228','#0c172e'],
    star:['#ffd966','#f5d050','#ffe880','#ffd040','#fff0a0','#fffacc'],
    blue:['#1e4fa0','#2a5ab0','#3a70d0','#4a80e0'],
    green:['#2a6030','#3a7a3a','#4a9040','#60b060'],
    purple:['#6a1a8a','#8030a0','#9040b0','#b060d0'],
  };
  function pick(a){return a[Math.floor(Math.random()*a.length)];}
  function lerp(a,b,t){return a+(b-a)*t;}

  const LAYERS=6;
  const LAYER_NAMES=['INPUT','EMBEDDING','ATTENTION¬∑1','FEED-FWD¬∑1','ATTENTION¬∑2','OUTPUT'];

  let bgStrokes=[];

  function swirlAngle(x,y,t){
    const nx=x/W,ny=y/H;
    return (Math.sin(nx*3.5+t*0.5)*Math.cos(ny*3+t*0.4)+Math.cos(nx*5.8-t*0.3)*Math.sin(ny*4.5+t*0.6)+Math.sin((nx+ny)*3.2+t*0.7))*Math.PI;
  }

  function buildBgStrokes(){
    bgStrokes=[];
    for(let i=0;i<220;i++){ // MORE swirls
      bgStrokes.push({x:Math.random()*W,y:Math.random()*H,angle:0,
        length:20+Math.random()*90,width:1.2+Math.random()*6,
        color:pick(PAL.sky),alpha:0.3+Math.random()*0.5,
        wobble:0.3+Math.random()*1.6});
    }
  }
  buildBgStrokes();

  function buildNeurons(){
    neurons=[];
    const perLayer=Math.max(7,Math.floor(H/60));
    for(let l=0;l<LAYERS;l++){
      const lx=W*(0.1+l*0.15);
      for(let n=0;n<perLayer;n++){
        const t2=(n+0.5)/perLayer;
        neurons.push({
          x:lx+(Math.random()-0.5)*40,
          y:H*0.08+H*0.84*t2+(Math.random()-0.5)*28,
          layer:l, activation:Math.random(), targetAct:Math.random(),
          firing:false, fireTimer:0,
          type:Math.random()<0.13?'attention':(Math.random()<0.15?'inhibitory':'excitatory'),
          connections:[], baseRadius:2.8+Math.random()*6,
          wobble:Math.random()*Math.PI*2,
        });
      }
    }
    neurons.forEach(n=>{
      if(n.layer>=LAYERS-1)return;
      const next=neurons.filter(m=>m.layer===n.layer+1);
      const k=2+Math.floor(Math.random()*3);
      for(let i=0;i<k;i++){
        const tgt=next[Math.floor(Math.random()*next.length)];
        if(tgt)n.connections.push({to:tgt,weight:(Math.random()*2-1)});
      }
    });
  }
  buildNeurons();

  function brushStroke(cx,cy,angle,length,width,color,alpha,wobble){
    ctx.save(); ctx.globalAlpha=alpha; ctx.translate(cx,cy); ctx.rotate(angle);
    const seg=Math.max(4,Math.floor(length/10));
    const step=length/seg;
    ctx.beginPath();
    let px2=-length/2,py2=0; ctx.moveTo(px2,py2);
    for(let i=1;i<=seg;i++){
      const nx=px2+step, ny=py2+(Math.random()-0.5)*width*wobble;
      const cpx=(px2+nx)/2+(Math.random()-0.5)*5*wobble;
      const cpy=(py2+ny)/2+(Math.random()-0.5)*width*wobble*0.9;
      ctx.quadraticCurveTo(cpx,cpy,nx,ny);
      px2=nx;py2=ny;
    }
    ctx.lineWidth=width; ctx.lineCap='round'; ctx.strokeStyle=color;
    ctx.shadowColor=color; ctx.shadowBlur=width*0.8; ctx.stroke();
    ctx.shadowBlur=0; ctx.globalAlpha=alpha*0.3; ctx.lineWidth=width*0.3;
    ctx.strokeStyle='#ffffff'; ctx.stroke();
    ctx.restore();
  }

  function drawNeuron(n,t){
    const firing=n.fireTimer>0;
    const pulse=firing?Math.sin(n.fireTimer*0.35)*0.6+0.4:0;
    let color,glowCol,r;
    if(n.type==='inhibitory'){color=pick(PAL.green);glowCol='#60df60';}
    else if(n.type==='attention'){color=pick(PAL.purple);glowCol='#e080f0';}
    else{color=firing?pick(PAL.star):pick(PAL.blue);glowCol=firing?'#fffacc':'#5080e0';}
    r=n.baseRadius*(1+n.activation*0.7+pulse*2);
    const wx=n.x+Math.sin(t+n.wobble)*1.5, wy=n.y+Math.cos(t*0.8+n.wobble*1.2)*1.5;

    // Starry glow
    for(let ring=4;ring>=1;ring--){
      const rr=r*(1+ring*0.7+pulse*ring*0.5);
      const grd=ctx.createRadialGradient(wx,wy,0,wx,wy,rr);
      grd.addColorStop(0,glowCol+(firing?'70':'55'));grd.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(wx,wy,rr,0,Math.PI*2);
      ctx.fillStyle=grd;ctx.globalAlpha=0.6;ctx.fill();ctx.globalAlpha=1;
    }
    for(let d=0;d<6;d++){
      const dx=wx+(Math.random()-0.5)*r*0.85,dy2=wy+(Math.random()-0.5)*r*0.85;
      ctx.beginPath();ctx.arc(dx,dy2,r*(0.4+Math.random()*0.55),0,Math.PI*2);
      ctx.fillStyle=color;ctx.globalAlpha=0.65+Math.random()*0.35;ctx.fill();
    }
    ctx.globalAlpha=1;
    ctx.beginPath();ctx.arc(wx-r*0.3,wy-r*0.3,r*0.35,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,250,0.55)';ctx.globalAlpha=firing?0.85:0.3;ctx.fill();ctx.globalAlpha=1;
    if(n.fireTimer>0)n.fireTimer--;
  }

  let connCanvas=null;
  function buildConnCanvas(){
    connCanvas=document.createElement('canvas');
    connCanvas.width=W;connCanvas.height=H;
    const cc=connCanvas.getContext('2d');
    neurons.forEach(n=>{
      n.connections.forEach(conn=>{
        const dx=conn.to.x-n.x,dy=conn.to.y-n.y;
        cc.save();cc.globalAlpha=0.18+Math.abs(conn.weight)*0.18;
        cc.beginPath();cc.moveTo(n.x,n.y);
        const cpx1=n.x+dx*0.35+(Math.random()-0.5)*35,cpy1=n.y+dy*0.35+(Math.random()-0.5)*35;
        const cpx2=n.x+dx*0.65+(Math.random()-0.5)*35,cpy2=n.y+dy*0.65+(Math.random()-0.5)*35;
        cc.bezierCurveTo(cpx1,cpy1,cpx2,cpy2,conn.to.x,conn.to.y);
        cc.strokeStyle=conn.weight>0?'#2a5ab0':'#3a7a3a';
        cc.lineWidth=1+Math.abs(conn.weight)*0.8;cc.lineCap='round';cc.stroke();cc.restore();
      });
    });
  }
  buildConnCanvas();

  let t=0;
  ctx.fillStyle='#040608'; ctx.fillRect(0,0,W,H);

  function frame(){
    if(currentMode!=='paint')return;
    t+=0.015;

    ctx.save();ctx.globalAlpha=0.02;
    ctx.fillStyle='#040608';ctx.fillRect(0,0,W,H);ctx.restore();

    ctx.save();ctx.globalAlpha=0.06;
    bgStrokes.forEach((s,i)=>{
      s.angle=swirlAngle(s.x,s.y,t);
      brushStroke(s.x,s.y,s.angle,s.length,s.width,s.color,s.alpha*(0.6+Math.sin(t*0.4+i*0.08)*0.4),s.wobble);
    });
    ctx.restore();

    // PROMINENT layer labels
    for(let l=0;l<LAYERS;l++){
      const lx=W*(0.1+l*0.15);
      const lgrd=ctx.createRadialGradient(lx,32,0,lx,32,50);
      lgrd.addColorStop(0,'rgba(255,217,102,0.2)');
      lgrd.addColorStop(1,'transparent');
      ctx.fillStyle=lgrd;
      ctx.fillRect(lx-50,15,100,34);
      
      ctx.save();
      ctx.shadowColor='rgba(255,235,153,1)';
      ctx.shadowBlur=10;
      ctx.fillStyle='#ffd966';
      ctx.font=`bold ${Math.min(13,W*0.022)}px Cinzel,Georgia,serif`;
      ctx.textAlign='center';
      ctx.fillText(LAYER_NAMES[l],lx,35);
      ctx.shadowBlur=0;
      ctx.restore();
      
      ctx.strokeStyle='rgba(255,217,102,0.5)';
      ctx.lineWidth=1;
      ctx.shadowBlur=3;
      ctx.beginPath();
      ctx.moveTo(lx-28,40);
      ctx.lineTo(lx+28,40);
      ctx.stroke();
      ctx.shadowBlur=0;
    }

    if(connCanvas)ctx.drawImage(connCanvas,0,0);

    neurons.forEach(n=>{
      if(n.fireTimer>30)n.connections.forEach(c=>{
        ctx.save();ctx.globalAlpha=0.75;
        ctx.beginPath();ctx.moveTo(n.x,n.y);ctx.lineTo(c.to.x,c.to.y);
        ctx.strokeStyle=pick(PAL.blue);ctx.lineWidth=1;ctx.stroke();ctx.restore();
      });
    });

    neurons.forEach(n=>{
      if(Math.random()<0.009)n.targetAct=Math.random();
      n.activation+=(n.targetAct-n.activation)*0.025;
      drawNeuron(n,t);
    });

    signals=signals.filter(s=>{
      s.p+=s.speed;
      const x=lerp(s.x,s.tx,s.p), y=lerp(s.y,s.ty,s.p);
      s.trail.push({x,y});if(s.trail.length>12)s.trail.shift();
      s.trail.forEach((p,i)=>{
        const f=i/s.trail.length;
        ctx.beginPath();ctx.arc(p.x,p.y,3*f,0,Math.PI*2);
        ctx.fillStyle=s.color;ctx.globalAlpha=f*0.7;ctx.fill();
      });
      ctx.globalAlpha=1;
      const grd=ctx.createRadialGradient(x,y,0,x,y,9);
      grd.addColorStop(0,'#fff');grd.addColorStop(0.35,s.color);grd.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(x,y,9,0,Math.PI*2);ctx.fillStyle=grd;ctx.globalAlpha=0.95;ctx.fill();
      ctx.globalAlpha=1;
      return s.p<1;
    });

    paintAnim=requestAnimationFrame(frame);
  }
  ctx.fillStyle='#040608';ctx.fillRect(0,0,W,H);
  frame();
}
</script>
</body>
</html>
